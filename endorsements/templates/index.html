{% extends "base.html" %}

{% load humanize %}

{% block title %}
    Election 2016 Endorsements
{% endblock %}

{% block buttons %}
{% include "add_endorser_snippet.html" %}
{% endblock %}

{% block content %}
<div class="ui message">
    <img alt="Logo" class="ui middle aligned tiny left floated image"
         src="https://s3.amazonaws.com/endorsementdb.com/images/endorsementdb.png" />
    <p>
        This project is an attempt to track candidate endorsements in the 2016
        US presidential election in a structured, non-partisan manner. We
        currently have {{ counts.total }} endorsers in our database. Use the
        form below to sort and filter endorsements by endorser attributes or by candidate.
    </p>
    <p>
        It's still under active development, so if you notice a bug, or
        error, or just something that could be improved, please send me an
        email at <a
        href="mailto:admin@endorsement.com">admin@endorsementdb.com</a>
        or find me on Twitter at <a
        href="https://twitter.com/endorsementdb">@endorsementdb</a>.
        If you're interested in helping out in any way, take a look at <a
        href="https://github.com/endorsementdb/endorsementdb.com">the
        GitHub repo</a>.
    </p>
</div>
{% verbatim %}
<template id="endorser-search-stats-template">
    <div v-if="stats">
        <div class="ui block header"
             @click="toggle_expanded"
             :class="expanded ? 'top attached' : ''">
            <i class="chevron down icon" v-if="!expanded"></i>
            <i class="chevron up icon" v-if="expanded"></i>
            Stats
        </div>
        <div class="ui bottom attached inverted segment"
             v-show="expanded"
             v-if="stats.positions">
            <h3>
                {{ stats.count.endorsers }} endorsers with
                {{ stats.count.endorsements }} distinct endorsements
            </h3>
            <div class="ui basic center aligned segment">
                <div class="ui buttons">
                    <button class="ui button"
                            :class="{active: tab == 'counts'}"
                            @click="tab = 'counts'">
                        Counts
                    </button>
                    <button class="ui button"
                            :class="{active: tab == 'positions'}"
                            @click="tab = 'positions'">
                        Positions
                    </button>
                    <button class="ui button"
                            :class="{active: tab == 'tags'}"
                            @click="tab = 'tags'">
                        Tags
                    </button>
                </div>
            </div>
            <div class="ui basic center aligned inverted segment"
                 v-if="tab == 'counts'">
                <p>
                    There are
                    {{ stats.count.endorsers }} endorsers
                    with
                    {{ stats.count.endorsements }} endorsements.
                </p>
                <p>
                    The mean number of followers
                    of each Twitter account is
                    {{ stats.followers.average }}.
                </p>
            </div>
            <table class="ui compact striped table" v-if="tab == 'tags'">
                <thead>
                    <tr>
                        <th>
                            Tag
                        </th>
                        <th>
                            Count
                        </th>
                        <th>
                            %
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(tag, tag_index) in stats.tags">
                        <td>
                            {{ tag.name }}
                        </td>
                        <td>
                            {{ tag.count }}
                        </td>
                        <td>
                            {{ percentage(tag.count, stats) }}
                        </td>
                    </tr>
                </tbody>
            </table>
            <table class="ui striped table" v-if="tab == 'positions'">
                <thead>
                    <tr>
                        <th>
                            Position
                        </th>
                        <th>
                            Count
                        </th>
                        <th>
                            %
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(position, pos_index) in stats.positions">
                        <td>
                            <i class="small inverted circular comment icon"
                               :class="position.icon"></i>
                            {{ position.name }}
                        </td>
                        <td>
                            {{ position.count }}
                        </td>
                        <td>
                            {{ percentage(position.count, stats) }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>

<template id="endorser-filter-form-tags-template">
    <div class="ui labels">
        <button class="ui label"
                :class="tag_is_selected(tag) ? 'black' : 'basic'"
                @click="toggle_tag(tag)"
                v-for="tag in tags">
            {{ tag.name }}
        </button>
    </div>
</template>

<template id="endorser-filter-form-exclusive-tags-template">
    <div class="ui form">
        <div class="inline fields">
            <div class="field"
                 @click="toggle_tag(tag)"
                 v-for="tag in tags">
                <div class="ui radio checkbox">
                    <input type="radio"
                           :checked="tag_is_selected(tag)"/>
                    <label>{{ tag.name }}</label>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="endorser-sort-filter-form-template">
    <div>
        <div class="ui attached segment">
            <div class="ui middle aligned grid">
                <div class="two wide column">
                    <h3>
                        <i class="sort icon"></i>
                        Sort
                    </h3>
                </div>
                <div class="fourteen wide right aligned column">
                    <div class="ui form">
                        <div class="fields" style="margin: 0; float: right">
                            <div class="inline field"
                                 v-for="sort_option in options.sorting">
                                <label>{{ sort_option.name }}</label>
                                <div class="ui buttons">
                                    <button class="ui button"
                                            v-for="option in sort_option.options"
                                            :class="{grey: sorting_by(sort_option.value, option.value)}"
                                            @click="sort(sort_option.value, option.value)">
                                        {{ option.name }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ui attached segment">
            <div class="ui middle aligned grid">
                <div class="two wide column">
                    <h3>
                        <i class="filter icon"></i> Filter
                    </h3>
                </div>
                <div class="fourteen wide right aligned column">
                    <div class="ui buttons">
                        <button v-for="tab in tabs.all"
                                @click="select_tab(tab.value)"
                                class="ui button"
                                :class="tabs.current == tab.value ? 'grey' : ''">
                            {{ tab.name }}
                        </button>
                    </div>
                </div>
            </div>
            <div v-if="tabs.current == 'organization'">
                <br />
                <div class="ui form">
                    <div class="field">
                        <label>Tags</label>
                        <endorser-filter-form-exclusive-tags :tags="options.filter.tags.org"
                                                   :selected_tags="form.filter.tags">
                        </endorser-filter-form-exclusive-tags>
                    </div>
                </div>
            </div>
            <div v-if="tabs.current == 'personal'">
                <br />
                <div class="ui form">
                    <div class="field"
                         v-for="tag_group in options.filter.tags.personal">
                        <label>{{ tag_group.name }}</label>
                        <div v-if="tag_group.exclusive">
                            <endorser-filter-form-exclusive-tags :tags="tag_group.tags"
                                                                 :selected_tags="form.filter.tags">
                            </endorser-filter-form-exclusive-tags>
                        </div>
                        <div v-if="!tag_group.exclusive">
                            <endorser-filter-form-tags :tags="tag_group.tags"
                                                       :selected_tags="form.filter.tags">
                            </endorser-filter-form-tags>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="ui center aligned bottom attached secondary segment">
            <div class="ui labeled button" :class="{disabled: loaders != 0}">
                <button class="ui large icon black button"
                        :disabled="loaders != 0"
                        :class="{'basic': form.filter.candidate != 'all'}"
                        @click="search('all')">
                    <i class="filter icon"></i>
                    All
                </button>
                <a class="ui basic black left pointing label">
                {% endverbatim %}
                    {{ counts.total }}
                {% verbatim %}
                </a>
            </div>
            <div class="ui labeled button" :class="{disabled: loaders != 0}">
                <button class="ui large blue icon button"
                        :disabled="loaders != 0"
                        :class="{'basic': form.filter.candidate != 'clinton'}"
                        @click="search('clinton')">
                    <i class="filter icon"></i>
                    Clinton
                </button>
                <a class="ui basic blue left pointing label">
                {% endverbatim %}
                    {{ counts.clinton }}
                {% verbatim %}
                </a>
            </div>
            <div class="ui labeled button" :class="{disabled: loaders != 0}">
                <button class="ui large red icon button"
                        :disabled="loaders != 0"
                        :class="{'basic': form.filter.candidate != 'trump'}"
                        @click="search('trump')">
                    <i class="filter icon"></i>
                    Trump
                </button>
                <a class="ui basic red left pointing label">
                {% endverbatim %}
                    {{ counts.trump }}
                {% verbatim %}
                </a>
            </div>
            <div class="ui labeled button" :class="{disabled: loaders != 0}">
                <button class="ui large green icon button"
                        :disabled="loaders != 0"
                        :class="{'basic': form.filter.candidate != 'stein'}"
                        @click="search('stein')">
                    <i class="filter icon"></i>
                    Stein
                </button>
                <a class="ui basic green left pointing label">
                {% endverbatim %}
                    {{ counts.stein }}
                {% verbatim %}
                </a>
            </div>
            <div class="ui labeled button" :class="{disabled: loaders != 0}">
                <button class="ui large orange icon button"
                        :disabled="loaders != 0"
                        :class="{'basic': form.filter.candidate != 'pence'}"
                        @click="search('pence')">
                    <i class="filter icon"></i>
                    Pence
                </button>
                <a class="ui basic orange left pointing label">
                {% endverbatim %}
                    {{ counts.pence }}
                {% verbatim %}
                </a>
            </div>
            <div class="ui labeled button" :class="{disabled: loaders != 0}">
                <button class="ui large yellow icon button"
                        :disabled="loaders != 0"
                        :class="{'basic': form.filter.candidate != 'johnson'}"
                        @click="search('johnson')">
                    <i class="filter icon"></i>
                    Johnson
                </button>
                <a class="ui basic yellow left pointing label">
                {% endverbatim %}
                    {{ counts.johnson }}
                {% verbatim %}
                </a>
            </div>
        </div>
    </div>
</template>

<template id="endorser-accounts-template">
    <div class="ui list">
        <div v-for="account in accounts"
             class="item">
            <div class="content">
                <i class="twitter icon"></i>
                <a :href="url(account)">
                    <strong>@{{ account.username }}</strong>
                </a>

                <span>
                    {{ account.num_followers }} followers
                </span>
             </div>
         </div>
    </div>
</template>

<template id="endorsement-label-template">
    <div class="ui label"
         :class="endorsement.colour">
         {{ endorsement.display }}
    </div>
</template>

<template id="endorsement-accordion-item-template">
    <div>
        <div class="title"
             :class="{active: expanded}"
             @click="toggle()">

            <i class="dropdown icon"></i>
            <endorsement-label :endorsement="endorsement">
            </endorsement-label>
            as of
            <div class="ui basic label">
                {{ endorsement.date }}
            </div>
        </div>
        <div class="content"
             :class="{active: expanded}">
            <blockquote :cite="endorsement.source_url">
                <p v-if="endorsement.event">
                    <em>
                        [{{ endorsement.event_context }}
                        <a :title="endorsement.event_dates">{{ endorsement.event }}</a>]
                    </em>
                    <br />
                    <br />
                </p>

                <p v-if="endorsement.context">
                    <em>[{{ endorsement.context }}]</em>
                    <br />
                    <br />
                </p>

                <p>{{ endorsement.quote }}</p>
                <footer>
                    <cite>
                        &mdash;
                        <a :href="endorsement.source_url">
                            {{ endorsement.source_name }}
                            <i class="external link icon"></i>
                        </a>
                        <span v-if="endorsement.date != endorsement.source_date">
                            (published {{ endorsement.source_date }})
                        </span>
                    </cite>
                </footer>
            </blockquote>
        </div>
    </div>
</template>

<template id="endorsements-accordion-template">
    <div>
        <div v-if="endorsements && endorsements.length"
             class="ui fluid accordion">
            <endorsement-accordion-item v-for="(endorsement, index) in endorsements"
                                        :present="index == 0"
                                        :endorsement="endorsement"
                                        :endorser="endorser">
            </endorsement-accordion-item>
        </div>
        <div v-else>
            <div v-if="endorser.is_candidate">
                <h3>{{ endorser.name }} is a candidate.</h3>
            </div>
            <div v-else>
                <h3>{{ endorser.name }} has not endorsed anyone yet.</h3>
            </div>
        </div>
    </div>
</template>

<template id="comments-accordion-template">
    <div v-if="comments && comments.length">
        <div class="ui divider"></div>
        <div class="ui fluid accordion">
             <h3>Comments</h3>
             <div v-for="comment in comments">
                {{ comment.candidate }}
             </div>
        </div>
    </div>
</template>

<template id="endorser-tags-template">
    <div class="ui labels">
        <div class="ui label"
             v-for="tag in tags"
             :title="tag.description">
            {{ tag.name }}
        </div>
    </div>
</template>

<template id="endorser-card-template">
    <div class="ui card">
        <div class="image">
            <img :src="endorser.image" />
        </div>

        <div class="content">
            <div class="header">
                <a :href="endorser.absolute_url">
                    {{ endorser.name }}
                </a>
            </div>
            <a :href="endorser.url"
               v-if="endorser.url"
               class="meta">
                {{ endorser.url }}
            </a>

            <p v-if="endorser.description"
               class="description">
                {{ endorser.description }}
            </p>

            <div class="ui divider"></div>

            <div class="ui labels"
                 v-if="endorser.tags.length">
                <endorser-tags :tags="endorser.tags">
                <endorser-tags>
            </div>

            <div class="ui divider"></div>

            <endorsements-accordion :endorser="endorser"
                                    :endorsements="endorser.endorsements">
            </endorsements-accordion>

            <comments-accordion :endorser="endorser"
                                :comments="endorser.comments">
            </comments-accordion>

            <div class="ui divider"></div>

            <endorser-accounts :accounts="endorser.accounts">
            </endorser-accounts>
        </div>
    </div>
</template>

<div id="app">
    <div>
        <endorser-sort-filter-form :loaders="loaders"
                                   @form_changed="get_endorsers">
        </endorser-sort-filter-form>

        <div class="ui divider"></div>

        <div v-if="endorsers != null">
            <div v-if="endorsers.length > 0">
                <endorser-search-stats :stats="stats">
                </endorser-search-stats>
                <div class="ui divider"></div>
            </div>

            <div class="ui three cards">
                <endorser-card v-for="(endorser, endorser_index) in endorsers"
                               v-if="endorser_index < endorsers_shown"
                               :endorser="endorser">
                </endorser-card>
            </div>
        </div>
        <div class="ui info message"
             v-if="endorsers != null && endorsers.length == 0">
            Could not find any endorsers.
        </div>
    </div>

    <div class="ui hidden divider"></div>

    <div v-if="loaders > 0">
        <div class="ui basic segment">
            <div class="ui active loader"></div>
        </div>
    </div>
</div>
{% endverbatim %}
{% endblock %}

{% block scripts %}
<script>
function get_form_from_hash() {
    if(!window.location.hash) return {};
    var hash_pairs = window.location.hash.substring(1).split('&');

    var hash_dict = {};
    hash_pairs.forEach(function(pair) {
        var split = pair.split('=');

        var field_name = split[0];

        if(split.length == 1) {
            hash_dict[field_name] = true;
        } else {
            var field_value = split[1];
            hash_dict[field_name] = field_value;
        }
    });
    if(typeof hash_dict.form === 'undefined') {
        return {};
    }

    var serialized = hash_dict.form;
    return JSON.parse(decodeURIComponent(escape(atob(serialized))));
}

get_form_from_hash();

function update_hash_with_form(form) {
    var serialized = 'form=';
    serialized += JSON.stringify(form);
    serialized = btoa(unescape(encodeURIComponent(JSON.stringify(form))));
}

Vue.component('endorser-search-stats', {
    template: '#endorser-search-stats-template',

    data: function() {
        return {
            expanded: false,
            tab: 'tags',
        };
    },

    methods: {
        toggle_expanded: function() {
            this.expanded = !this.expanded;
        },
        percentage: function(num, stats) {
            var total = stats.count.endorsers;
            return (100 * num / total).toFixed(1);
        },
    },

    props: ['stats'],
});

Vue.component('endorser-filter-form-tags', {
    template: '#endorser-filter-form-tags-template',

    methods: {
        tag_is_selected: function(tag) {
            return this.selected_tags.indexOf(tag.pk) >= 0;
        },
        toggle_tag: function(tag) {
            var tag_index = this.selected_tags.indexOf(tag.pk);

            if(tag_index >= 0) {
                this.selected_tags.splice(tag_index, 1);
            } else {
                this.selected_tags.push(tag.pk);
            }
        },
    },

    props: ['selected_tags', 'tags'],
});

Vue.component('endorser-filter-form-exclusive-tags', {
    template: '#endorser-filter-form-exclusive-tags-template',

    methods: {
        tag_is_selected: function(tag) {
            return this.selected_tags.indexOf(tag.pk) >= 0;
        },
        toggle_tag: function(tag) {
            if(this.tag_is_selected(tag)) {
                this.raw_unselect_tag(tag);
            } else {
                this.tags.forEach(this.raw_unselect_tag);
                this.selected_tags.push(tag.pk);
            }
        },

        raw_unselect_tag: function(tag) {
            var tag_index = this.selected_tags.indexOf(tag.pk);
            if(tag_index >= 0) {
                this.selected_tags.splice(tag_index, 1);
            }
        }
    },

    props: ['selected_tags', 'tags'],
});

Vue.component('endorser-sort-filter-form', {
    template: '#endorser-sort-filter-form-template',

    data: function() {
        return {
            form: {
                sort: {
                    by: 'followers',
                    value: 'most',
                },
                filter: {
                    tags: [],
                    mode: 'none',
                    candidate: 'all',
                },
            },
            tabs: {
                current: 'none',
                all: [
                    { name: 'All endorsements', value: 'none' },
                    { name: 'People only', value: 'personal' },
                    { name: 'Organizations only', value: 'organization' },
                ],
            },
            options: {
                sorting: [
                    {
                        name: 'Followers',
                        value: 'followers',
                        options: [
                            { name: 'Most', value: 'most' },
                            { name: 'Least', value: 'least' },
                        ],
                    },
                    {
                        name: 'Endorsement date',
                        value: 'date',
                        options: [
                            { name: 'Newest first', value: 'newest' },
                            { name: 'Oldest first', value: 'oldest' },
                        ],
                    },
                    {
                        name: 'Name',
                        value: 'name',
                        options: [
                            { name: 'A-Z', value: 'az' },
                            { name: 'Z-A', value: 'za' },
                        ],
                    },
                ],
                filter: {
                    tags: {},
                }
            },
        };
    },

    methods: {
        sort: function(method, value) {
            this.form.sort.by = method;
            this.form.sort.value = value;
        },
        sorting_by: function(method, value) {
            return this.form.sort.by == method &&
                   this.form.sort.value == value;
        },

        get_tags: function() {
            var component = this;
            var tagsUrl = '/api/tags.json';

            $.getJSON(tagsUrl)
            .done(function(tag_options) {
                component.options.filter.tags = tag_options;
            });
        },

        select_tab: function(tab) {
            this.form.filter.tags = [];
            this.form.filter.mode = tab;
            this.tabs.current = tab;
        },

        search: function(candidate) {
            this.form.filter.candidate = candidate;
            this.$emit('form_changed', this.form);
        },
    },

    mounted: function() {
        this.get_tags();

        // See if there's a candidate specified in the URL. TODO: Improve.
        var candidate = 'all';
        if (window.location.hash.startsWith('#candidate=')) {
            candidate = window.location.hash.substring(11);
        }
        this.search(candidate);
    },

    props: ['loaders'],
});

Vue.component('endorser-accounts', {
    template: '#endorser-accounts-template',

    methods: {
        url: function(account) {
            return 'https://twitter.com/' + account.username;
        },
    },

    props: ['accounts'],
});

Vue.component('endorsement-label', {
    template: '#endorsement-label-template',

    props: ['endorsement'],
});

Vue.component('endorsement-accordion-item', {
    template: '#endorsement-accordion-item-template',

    data: function() {
        return {
            expanded: false,
        };
    },

    methods: {
        toggle: function() {
            this.expanded = !this.expanded;
        },
    },

    props: ['endorser', 'endorsement', 'present'],
});

Vue.component('comments-accordion', {
    template: '#comments-accordion-template',

    props: ['endorser', 'comments'],
});

Vue.component('endorsements-accordion', {
    template: '#endorsements-accordion-template',

    props: ['endorser', 'endorsements'],
});

Vue.component('endorser-tags', {
    template: '#endorser-tags-template',

    props: ['tags'],
});

Vue.component('endorser-card', {
    template: '#endorser-card-template',

    props: ['endorser'],
});

new Vue({
    el: '#app',

    created: function() {
        var component = this;

        $(window).scroll(function() {
            var current_position = $(window).scrollTop() + $(window).height();
            var doc_height_with_buffer = $(document).height() - 100;

            if(current_position >= doc_height_with_buffer) {
                component.$emit('maybe-load-more-endorsers');
            }
        });

        component.$on('maybe-load-more-endorsers', function() {
            if(component.endorsers && component.endorsers_shown < component.endorsers.length) {
                component.endorsers_shown += component.page_size;
            }
        });
    },

    data: {
        loaders: 0,
        endorsers: null,
        page_size: 9,
        endorsers_shown: 9,
        stats: null,
    },

    methods: {
        get_endorsers: function(form) {
            var component = this;

            component.endorsers = null;
            component.endorsers_shown = component.page_size;
            component.stats = null;

            component.loaders += 1;

            var endorsersUrl = "/api/endorsements.json";

            $.ajax({
                type: 'POST',
                url: endorsersUrl,
                data: JSON.stringify(form),
                contentType: 'application/json'
            })
            .done(function(response) {
                var endorsers = response.endorsers;
                component.endorsers = endorsers;

                var sorted_tags = [];
                for(var tag_name in response.stats.tags) {
                    sorted_tags.push({
                        name: tag_name,
                        count: response.stats.tags[tag_name],
                    });
                }
                sorted_tags.sort(function(x,y) {
                    return y.count - x.count;
                });
                response.stats.tags = sorted_tags;

                var sorted_positions = [];
                for(var position_name in response.stats.positions) {
                    var icon = '';

                    if(position_name.indexOf('Endorse') >= 0) icon = 'green';
                    if(position_name.indexOf('Support') >= 0) icon = 'blue';
                    if(position_name.indexOf('Oppose') >= 0) icon = 'red';

                    sorted_positions.push({
                        name: position_name,
                        icon: icon,
                        count: response.stats.positions[position_name],
                    });
                }
                sorted_positions.sort(function(x,y) {
                    return y.count - x.count;
                });
                response.stats.positions = sorted_positions;

                var avg_followers = response.stats.followers.total;
                if (avg_followers > 0) {
                    avg_followers /= response.stats.followers.count;
                    avg_followers = Math.floor(avg_followers);
                    response.stats.followers.average = avg_followers;
                }

                component.stats = response.stats;

                component.loaders -= 1;
            });
        },
    },

    mounted: function() {
    },
});
</script>
{% endblock %}
